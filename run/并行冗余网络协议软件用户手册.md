# 并行冗余网络协议软件用户手册

[TOC]

## 1 产品简介

### 1.1 产品功能简要介绍

PRIP 并行冗余互联协议具备以下四个基本功能: 

(1) 数据冗余发送。数据冗余发送指的是:将数据包生成双份携带相同有效载荷的数据包,并为它们分别添加 PRIP 协议相关数据,最终确保将这两份携带相同载荷的数据包从不同的物理链路发送出去。

(2) 数据冗余接收。由于 PRIP 协议采用数据冗余发送,所以总会收到两份携带相同数据的数据包。对于首先到的那份数据包,予以接收;后到的那份,视为冗余,予以丢弃。

(3) 链路告警功能。在数据冗余接收过程中,根据两条链路的收包情况分析链路的运行状况,并在链路出现异常时候向用户发出告警信息。

(4) 影响正常网络通信。PRIP 协议通信的存在不会对正常的网络功能造成影响,同时对正常网络性能的影响也会保持在%1 的可接受范围内。

 

### 1.2准备工作

提供的产品成果物为带有PRIP的内核镜像软件包



### 1.3提供的产品md5值



### 1.4 安装部署环境

2f31b33579ba170a777f05e3ea87ce8e  linx-********amd64-DVD-1.iso

 

## 2 安装

### 2.1 安装过程

### 2.2 软件验证

1.安装后，重启主机，在选择系统镜像版本界面上选择2.6.32-696-linx-prip-amd64

进入系统后，打开终端

执行uname -r

查看系统内核镜像版本

若系统版本镜像为2.6.32-696-linx-prip-amd64，则表示带有PRIP协议的内核镜像包安装成功

如下图所示

![img](../image/凝思并行冗余网络协议软件用户手册/查看内核版本.png) 

## 3 功能配置

首先查看 /proc/prip/ 目录下是否有 prip_config、prip_alarm、prip_state、 prip_cache_timeout 四个文件

以及/proc/sys/net/ipv4/prip_set 文件

### 3.1 模式配置

其中prip_config文件是主从链路网段的配置

设置方式为：`echo 24 > /proc/prip/prip_config`

24是255.255.255.0 子网掩码的十进制格式

如下图所示

![img](../image/凝思并行冗余网络协议软件用户手册/模式配置.png) 

 

### 3.2 链路报警阈值配置

prip_alarm 文件是链路报警阀值的配置文件，默认大小是500，格式为十进制数

配置方式为：`echo 50 > /proc/prip/prip_alarm`

如下图所示

![img](../image/凝思并行冗余网络协议软件用户手册/链路报警阀值配置.png) 

### 3.3 链路状态显示

prip_state 文件是PRIP链路状态显示文件

1.如果没有配置 prip_config 文件时,用户访问/proc/prip/prip_state 没有任何输出。

2.当 配 置 了 prip_config 文 件 时 , 但 没 有 应 用 程 序 开 启 PRIP 功 能 时 , 用 户 访

问/proc/prip/prip_state 文件时的输出

如下图所示

![img](../image/凝思并行冗余网络协议软件用户手册/链路状态显示.png) 

 

### 3.4 缓存老化超时机制配置

prip_cache_timeout文件是缓存老化机制超时配置文件，默认大小是1

配置方式为：echo 30 > /proc/prip/prip_cache_timeout

如下图所示

![img](../image/凝思并行冗余网络协议软件用户手册/缓存老化超时机制配置.png) 

### 3.5 全局模式配置

/proc/sys/net/ipv4/prip_set 文件是PRIP全局模式配置文件。

PRIP全局模式：开启此模式后，应用发送的数据包都是PRIP数据包，但无需在应用中添加PRIP选项。

1.该文件在没有配置/proc/prip/prip_config 文件时，无法访问该文件

2.配置完/proc/prip/prip_config 文件后，/proc/sys/net/ipv4/prip_set 文件内容默认为0，即默认不开启PRIP全局模式，配置方式为：

​			`echo 1 > /proc/sys/net/ipv4/prip_set`

如下图所示

![img](../image/凝思并行冗余网络协议软件用户手册/全局模式配置.png) 

## 4 使用示例

### 4.1 准备环境

#### 4.1.1 物理硬件环境

拥有两个及以上网口的千兆以入网网卡的两台主机，网络拓扑图如下。

 

<img src="../image/凝思并行冗余网络协议软件用户手册/用户手册网络拓扑图.png" alt="img" style="zoom:75%;" /> 

成功安装PRIP ，以及验证系统后，首先需要做的就是对主从链路两端的网口设置IP地址  

主链路和从链路的本地端和对端可参照以下IP地址配置

 

主链路 本地端 192.168.0.171/24 对端 192.168.0.172/24

从链路 本地端 192.168.1.171/24 对端 192,168.1.172/24

 

将192.168.0网段的两个网口通过两个交换机相联接。

将192.168.1网段的两个网口通过另外两个交换机相联接。



### 4.2 PRIP冗余传输

#### 4.2.1 冗余通信

1. 设置好PRIP，在两台通信主机上分别将子网掩码长度写入到配置文件/proc/prip/prip_config中。

   ​	`	echo 24 > /proc/prip/prip_config `

2. 两端主机分为客户端和服务端，各运行客户端代码，服务端代码，并且在代码中添加了5.1节中灰色的代码段，添加数据包中的PRIP选项。

3. 先运行服务端代码，再运行服务端代码，使用tcpdump在服务端端主机的主从链路的两个网口进行抓包，抓包结果如下

​             ![img](../image/凝思并行冗余网络协议软件用户手册/4.2.1.png)

 

#### 4.2.2 冗余通信与非冗余通信

1. 设置好PRIP，在两台通信主机上分别将子网掩码长度写入到配置文件/proc/prip/prip_config中。

    			`echo 24 > /proc/prip/prip_config`

2. 一组终端界面上运行添加了PRIP选项的客户服务端代码，客户端发送hello

3. 另一组终端界面上运行没有添加PRIP选项的客户服务端代码，客户端发送world

4. 使用tcpdump在服务端端主机的主从链路的两个网口进行抓包，抓包结果如下

​          ![img](../image/凝思并行冗余网络协议软件用户手册/4.2.2.1.png)

 

​      ![img](../image/凝思并行冗余网络协议软件用户手册/4.2.2.2.png)

 

两者可以并存，并且互不影响

#### 4.2.3 冗余数据唯一接受

1. 设置好PRIP，在两台通信主机上分别将子网掩码长度写入到配置文件/proc/prip/prip_config中。                   		  

    `echo 24 > /proc/prip/prip_config`

2. 运行服务端，客户端代码，客户端命令行输入任意字符

  ![img](../image/凝思并行冗余网络协议软件用户手册/客户端输入.png) 

3. 服务端接收到数据后将数据打印在终端

结果如下：

![img](../image/凝思并行冗余网络协议软件用户手册/服务端输出.png) 

服务端只打印一次数据，表明应用程序只接收到一份数据包，冗余数据包在IP层就被内核抛弃了。



### 4.3 PRIP全局模式

1. 设置好PRIP，在两台通信主机上分别将子网掩码长度写入到配置文件/proc/prip/prip_config中。

   ​		`echo 24 > /proc/prip/prip_config`

2. 开启PRIP全局模式

   ​		`echo 1 > /proc/sys/net/ipv4/prip_set`

3. 运行tcpdump抓取服务端主机的主从链路网口的数据包

4. 运行ssh连接服务端的主链路ip

![img](../image/凝思并行冗余网络协议软件用户手册/ssh.png) 



主从链路的网口都能抓取到ssh连接的数据信息，证明普通程序在全局模式下也是冗余传输的。



### 4.4 PRIP链路故障

#### 4.4.1 链路故障零延时切换

1. 设置好PRIP，在两台通信主机上分别将子网掩码长度写入到配置文件/proc/prip/prip_config中。

   ​		`	echo 24 > /proc/prip/prip_config`

2. 开启PRIP全局模式

   ​		`echo 1 > /proc/sys/net/ipv4/prip_set`

3. 在客户端使用ssh登录服务端，通过命令行指令使得主从链路发送数据，而在发送数据的过程中，拔除主链路的通信网线，此时客户端ssh登录没有断开，服务端主从链路tcpdump抓包结果如下

![img](../image/凝思并行冗余网络协议软件用户手册/4.4.1.png)

![img](../image/凝思并行冗余网络协议软件用户手册/4.4.2.png) 

 

4. 此时在客户端主链路ip已经ping不通了，客户端主链路tcpdump抓包没有数据，从链路此时能ping通，tcpdump抓包有数据。

某条链路故障时，另一条链路承担通信的任务，并且是零延时切换。

#### 4.4.2 链路连续丢包超过阀值以及报警日志文件查看

1. 设置好PRIP，在两台通信主机上分别将子网掩码长度写入到配置文件/proc/prip/prip_config中。

   ​		`echo 24 > /proc/prip/prip_config`

2. 开启PRIP全局模式

   ​		`echo 1 > /proc/sys/net/ipv4/prip_set`

3. 配置/proc/prip/prip_alarm文件

   ​    	`	echo 50 > /proc/prip/prip_alarm`

4. 客户端运行ssh登录服务端，在通信过程中拨除主通信链路上交换机之间的网线，并且。

查看/var/log/message文件

![img](../image/凝思并行冗余网络协议软件用户手册/查看日志.png) 

查看/proc/prip/prip_state文件。

![img](../image/凝思并行冗余网络协议软件用户手册/查看prip_state.png) 

某条链路连续丢包超过阀值后，该链路不再工作，日志文件中打印错误信息，以及链路状态信息

 

## 5 常见问题

### 5.1 未开启PRIP全局模式能实现冗余传输吗

在未开启PRIP全局模式下，只有一种途径实现冗余传输数据的功能，就是在应用程序内添加PRIP选项代码段，而开启PRIP全局模式后，不添加PRIP选项代码段也能进行冗余传输

### 5.2 一条链路连续丢包会造成数据丢失吗

一条链路丢包不会造成数据丢失，另一条正常链路会承担起发送数据的任务，并且是零延时转换

### 5.3 PRIP全局模式需要收发数据双方两端都开启吗

是的，需要收发数据双方都开启PRIP全局模式，若一方开启，一方未开启，会导致未开启的一方，无法收到冗余数据包，无法形成冗余链路

