# 基于IP协议扩展的并行冗余网络协议



目录：

[toc]

## 1 背景

在一些重要工业控制领域，对网络通信的可靠性和实时性有着极高的要求。传统冗余通信解决方案诸如热备份切换机制，由于切换时间过长且代价较高，不能满足要求。IEC62438-3规定了冗余通信协议并行冗余协议PRP和高可用性无缝冗余协议HSR，满足了0延时切换的需求，但对网络设备或网络拓扑有特殊的要求，建设难度大、成本高，在国内推广较难。

在对现有网络冗余协议的研究分析后，我们认为通信网络冗余机制应基于软件实现，对内核网络协议栈进行二次开发，能够满足高可靠性和高实时性要求，可以在普通网络设备和环境中实现，避免诸多限制，降低网络冗余实施的难度和成本。



## 2 分析与设计

PRIP协议以Linux操作系统为平台，在内核网络协议栈的网络层，通过对IP协议进行扩展，旨在为冗余网络通信提供一种全新的解决方案。

### 2.1 分析

冗余网络通信的主要需求有以下几方面：

首先，应具有网络冗余容错功能，鉴于国内工控领域多以星状网为标准，宜采用双网冗余架构，通过两条链路发送数据，当单链路发生故障时，冗余链路可以保证数据的有效通信，并且保证0切换延时。因此在接收数据包时，需要设计一种有效的冗余接收算法。同时单链路发生故障时，需要发出告警信息，并在排除故障后能够回归正常冗余通信状态。

其次，应完全由软件实现，数据包的处理由操作系统内核完成，不依赖于特定的网络设备和网络拓扑。

再次，应保证协议的兼容性，冗余数据和正常数据和谐共存，互不干扰，可以适用于各种应用场景。因此冗余数据应增加标识符，并在网络协议栈中对数据进行分流处理，冗余通信数据包按照冗余通信协议处理，正常数据按照相应正常协议处理。

最后，应在内核网络协议栈实现，一是利用操作系统的内核保护机制保证协议的安全性，二是确保网络的高性能和可用性，三是对用户程序完全透明。工控服务器多使用Linux/UNIX系统，因此冗余网络通信协议应在成熟稳定版本的Linux操作系统中实现，便于应用迁移。

基于对现有网络冗余协议的研究和工控网络冗余需求的分析，PRIP协议在操作系统网络协议栈的第三层实现网络冗余核心功能，摆脱硬件依赖，极大降低建设难度和成本。

 

### 2.2 总体设计

PRIP在网络层增加了发送和接收处理模块。发送数据时，数据包被PRIP发送模块处理后，查询路由中是否已缓存了该数据包的链路层协议头，有则快速发送，无则将链路层协议头缓存下来再发送，方便下次快速发送。

收到数据包时，先进行路由，若不是发给本机则转发出去，若是则进入PRIP接收处理模块，处理后向上层传递。



### 2.3 模块设计

#### 2.3.1 专有IP选项

采用专有IP选项，以便对主从链路的数据包进行跟踪和冗余管理。专有IP选项属于本方案对IP选项的扩展，协议栈本身不能识别，PRIP协议提供了专有IP选项的组装与解析方法。



#### 2.3.2 冗余发送模块

在IP网络层增加冗余发送处理模块，实现了数据分流处理：普通数据包走协议栈正常流程；冗余通信数据包进行冗余发送处理。数据分流处理实现了正常通信和冗余通信的相互独立、互不干扰。

冗余发送流程主要有以下步骤：

​	(1) 初始化主包IP协议头，构建专有IP选项。

​	(2) 复制主包生成从包。

​	(3) 发送主包，并记录主包发送成功与否。

​	(4) 替换从包目的IP地址。

​	(5) 发送从包。



#### 2.3.3 多主机通信实现

在多主机进行冗余通信时候，一个重要问题就是序列号管理。流水序列号是进行冗余通信的重要基础，主机主要依据数据包携带的序列号在接收冗余数据时候来实现重复包的丢弃。每个主机在发送数据时候，都会为发送数据包添加新的流水序列号，若一台主机与多个主机同时进行冗余通信，那么这台主机接收到的数据包的序列号来源不再唯一，如果在以序列号为依据对数据包进行接收，必将引起混乱。因而，如何组织管理这些不同主机产生的序列号将显得尤为重要。

本方案为每两台冗余通信的主机，即每个IP对，维护了一个私有数据结构。该私有数据结构包含了两台主机进行通信的序列号，每次进行冗余发送时，首先获取该私有结构体然后得到流水序列号，将该值递增后作为本次数据包携带的流水序列号。



#### 2.3.4 冗余接收模块

通过在IP网络层接收路径上增加冗余接收分支来实现冗余接收功能，实现了数据分流处理：普通IP数据包走协议栈正常发送流程；属于冗余通信的IP数据包进入冗余接收分支处理。

冗余接收主要目的是为了丢弃重复包，对于携带同一序列号的两个数据包，对于先到达的进行接收，后到达的予以丢弃，最终实现唯一接收。另外在冗余接收中还对主从链路运行状况进行监控，即链路故障告警功能。

冗余接收处理流程主要有以下步骤：

​	(1) 获取流水序列号和主从包的标志，判断是主包还是从包。

​	(2) 如果是从包，需要将目的IP替换为本主机的主网卡接口IP。

​	(3) 通过重复包丢弃算法进行处理。如果该序列号的数据包已经收到，进行丢弃处理；如果该序列号的数据包是第一次到达，则予以接收。

​	(4) 将数据包向上层协议投递。



#### 2.3.5 重复包丢弃算法

重复包丢弃算法是冗余接收模块的核心，主要功能是：对于一个数据包，根据其携带的流水序列号和发送时间戳去查询接收状态缓存位图，看在本轮流水序列号轮转中，该序列号的数据包是否是第一次到达，如果是，则予以接收，并更新该序列号在缓存表中的接收状态;否则，是重复包，予以丢弃。



#### 2.3.6 链路故障报警

链路故障报警用于当一条链路丢包超过设定阈值时发出告警信息，用于监控链路运行状态。

主要使用了以下变量：

- 链路收包数：指的是该链路自开机以来所收到的冗余数据包的总数量；

- 报警计数：指的是自从本链路收到上一个数据包的时间算起，到下一个数据包到来之前，另一条链路所接收到的数据包的个数；

- 报警阈值：指的是一条链路连续丢包而不引起报警的个数上限制，超过这个阈值，本链路就会发出故障报警信息，报警阈值可由用户灵活配置。